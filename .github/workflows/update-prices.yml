name: MapleStory Equipment Price Auto Update

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:
    inputs:
      target_items:
        description: 'Number of items to update (default: ALL)'
        default: 'ALL'
        type: string

permissions:
  contents: write
  actions: read

env:
  TZ: Asia/Tokyo

jobs:
  update-prices:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Setup Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Setup Chrome and ChromeDriver
      run: |
        sudo apt-get update
        sudo apt-get install -y wget gnupg
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
        echo "Using simplified ChromeDriver download approach"
        CHROMEDRIVER_VERSION="136.0.7103.92"
        
        CHROMEDRIVER_URL="https://storage.googleapis.com/chrome-for-testing-public/$CHROMEDRIVER_VERSION/linux64/chromedriver-linux64.zip"
        echo "Downloading from: $CHROMEDRIVER_URL"
        
        wget -O /tmp/chromedriver.zip "$CHROMEDRIVER_URL" || {
          echo "Download failed, trying alternative version"
          CHROMEDRIVER_VERSION="135.0.7103.92"
          CHROMEDRIVER_URL="https://storage.googleapis.com/chrome-for-testing-public/$CHROMEDRIVER_VERSION/linux64/chromedriver-linux64.zip"
          wget -O /tmp/chromedriver.zip "$CHROMEDRIVER_URL"
        }
        
        sudo unzip /tmp/chromedriver.zip -d /tmp/
        sudo mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver
        
        echo "Installation completed:"
        google-chrome --version
        chromedriver --version
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Update equipment prices
      run: |
        echo "Starting MapleStory Equipment Price Auto Update at $(date '+%Y-%m-%d %H:%M:%S JST')"
        python scripts/update_prices.py
        echo "MapleStory Equipment Price Auto Update completed at $(date '+%Y-%m-%d %H:%M:%S JST')"
      env:
        TARGET_ITEMS: ${{ github.event.inputs.target_items || 'ALL' }}
        PYTHONPATH: ${{ github.workspace }}
    
    # ðŸ”„ å€‹åˆ¥ã‚¢ã‚¤ãƒ†ãƒ ä¾¡æ ¼å±¥æ­´æ›´æ–°ï¼ˆåˆ†é›¢ã•ã‚ŒãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼‰
    - name: Update individual item price history
      run: |
        echo "ðŸ”„ Starting individual item price history update at $(date '+%Y-%m-%d %H:%M:%S JST')"
        python scripts/historical_price_tracker.py
        echo "âœ… Individual item price history update completed at $(date '+%Y-%m-%d %H:%M:%S JST')"
      env:
        PYTHONPATH: ${{ github.workspace }}
    
    # ðŸ“Š ç·ä¾¡æ ¼é›†è¨ˆå‡¦ç†ï¼ˆåˆ†é›¢ã•ã‚ŒãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼‰
    - name: Aggregate total price data
      run: |
        echo "ðŸ“Š Starting total price aggregation at $(date '+%Y-%m-%d %H:%M:%S JST')"
        python scripts/total_price_aggregator.py
        echo "âœ… Total price aggregation completed at $(date '+%Y-%m-%d %H:%M:%S JST')"
      env:
        PYTHONPATH: ${{ github.workspace }}
    
    # ðŸ“ˆ å€‹åˆ¥ã‚¢ã‚¤ãƒ†ãƒ ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿å‡ºåŠ›
    - name: Export individual item chart data
      run: |
        echo "ðŸ“ˆ Exporting individual item chart data for web display"
        python -c "
        import sys
        sys.path.append('scripts')
        from historical_price_tracker import HistoricalPriceTracker
        import json
        import os
        
        try:
            tracker = HistoricalPriceTracker()
            
            # equipment_prices.jsonãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if not os.path.exists('data/equipment_prices.json'):
                print('equipment_prices.json not found, skipping chart export')
                sys.exit(0)
            
            with open('data/equipment_prices.json', 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            exported = 0
            total_items = len(data)
            
            print(f'Starting chart export for {total_items} items...')
            
            for i, item_id in enumerate(data.keys()):
                if i % 50 == 0:  # é€²æ—è¡¨ç¤º
                    print(f'Progress: {i}/{total_items} items processed')
                
                for interval in ['1hour', '12hour', '1day']:
                    try:
                        if tracker.export_chart_data_for_web(item_id, interval):
                            exported += 1
                    except Exception as e:
                        print(f'Error exporting chart for item {item_id} ({interval}): {e}')
                        continue
            
            print(f'âœ… Exported {exported} individual item chart data files')
            
        except Exception as e:
            print(f'âŒ Error in chart export: {e}')
            sys.exit(1)
        "
      env:
        PYTHONPATH: ${{ github.workspace }}
    
    # ðŸ“Š ç·ä¾¡æ ¼ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿å‡ºåŠ›ç¢ºèª
    - name: Verify total price chart data
      run: |
        echo "ðŸ“Š Verifying total price chart data files"
        
        for interval in 1hour 12hour 1day; do
          file="data/price_history/total_price_${interval}.json"
          if [ -f "$file" ]; then
            size=$(stat -c%s "$file")
            echo "âœ… ${file}: ${size} bytes"
            
            # JSONãƒ•ã‚¡ã‚¤ãƒ«ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
            if python -c "import json; json.load(open('$file'))"; then
              echo "   JSON format: valid"
            else
              echo "   âŒ JSON format: invalid"
            fi
          else
            echo "âŒ ${file}: not found"
          fi
        done
    
    # ðŸ” æ”¹å–„ã•ã‚ŒãŸå¤‰æ›´æ¤œå‡ºï¼ˆprice_historyã¨equipment_pricesã®ä¸¡æ–¹ï¼‰
    - name: Check for changes
      id: check-changes
      run: |
        # ãƒ‡ãƒ¼ã‚¿ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å¤‰æ›´ã‚’ãƒã‚§ãƒƒã‚¯
        if [ -n "$(git status --porcelain data/)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "âœ… Data changes detected:"
          git status --short data/
          
          # è©³ç´°ãªå¤‰æ›´æƒ…å ±ã‚’å–å¾—
          EQUIPMENT_CHANGED=$(git status --porcelain data/equipment_prices.json | wc -l)
          HISTORY_CHANGED=$(git status --porcelain data/price_history/ | wc -l)
          
          echo "equipment_changed=${EQUIPMENT_CHANGED}" >> $GITHUB_OUTPUT
          echo "history_changed=${HISTORY_CHANGED}" >> $GITHUB_OUTPUT
          
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ No changes detected in data directory"
          echo "equipment_changed=0" >> $GITHUB_OUTPUT
          echo "history_changed=0" >> $GITHUB_OUTPUT
        fi
    
    # ðŸ“¤ æ”¹å–„ã•ã‚ŒãŸã‚³ãƒŸãƒƒãƒˆï¼ˆåˆ†é›¢ã•ã‚ŒãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆå¯¾å¿œï¼‰
    - name: Commit and push changes
      if: steps.check-changes.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        
        # å¤‰æ›´ã®è©³ç´°æƒ…å ±ã‚’å–å¾—
        UPDATED_COUNT=$(git diff data/equipment_prices.json | grep -c '^+.*item_price' || echo "0")
        INDIVIDUAL_CHARTS=$(find data/price_history -name "*_1hour.json" ! -name "total_price_*" 2>/dev/null | wc -l || echo "0")
        TOTAL_CHARTS=$(find data/price_history -name "total_price_*.json" 2>/dev/null | wc -l || echo "0")
        CURRENT_TIME=$(date '+%Y-%m-%d %H:%M:%S JST')
        
        # çµ±è¨ˆæƒ…å ±ã®ç”Ÿæˆ
        if [ -f "data/equipment_prices.json" ]; then
          TOTAL_ITEMS=$(python -c "import json; print(len(json.load(open('data/equipment_prices.json'))))" 2>/dev/null || echo "0")
        else
          TOTAL_ITEMS="0"
        fi
        
        git add data/
        git commit -m "Auto-update: Equipment prices & historical data (åˆ†é›¢ã‚¹ã‚¯ãƒªãƒ—ãƒˆå¯¾å¿œ)

ðŸ“Š Update Summary:
- Update time: ${CURRENT_TIME}
- Total items: ${TOTAL_ITEMS}
- Updated items: ${UPDATED_COUNT}
- Individual charts: ${INDIVIDUAL_CHARTS}
- Total price charts: ${TOTAL_CHARTS}

ðŸ”§ Architecture:
- Individual item history: scripts/historical_price_tracker.py
- Total price aggregation: scripts/total_price_aggregator.py
- Automated by GitHub Actions (åˆ†é›¢ã‚¹ã‚¯ãƒªãƒ—ãƒˆç‰ˆ)"
        
        git push origin ${{ github.ref_name }}
        
        echo "âœ… Successfully updated ${UPDATED_COUNT} items with ${INDIVIDUAL_CHARTS} individual charts and ${TOTAL_CHARTS} total price charts"
    
    # ðŸ“ˆ è©³ç´°ãªå®Ÿè¡Œã‚µãƒžãƒªãƒ¼ç”Ÿæˆ
    - name: Generate detailed summary
      run: |
        echo "## ðŸ MapleStory Equipment Price Auto Update Results (åˆ†é›¢ã‚¹ã‚¯ãƒªãƒ—ãƒˆç‰ˆ)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š åŸºæœ¬æƒ…å ±" >> $GITHUB_STEP_SUMMARY
        echo "| Item | Result |" >> $GITHUB_STEP_SUMMARY
        echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| å®Ÿè¡Œæ™‚åˆ» | $(date '+%Y-%m-%d %H:%M:%S JST') |" >> $GITHUB_STEP_SUMMARY
        echo "| ãƒ‡ãƒ¼ã‚¿å¤‰æ›´ | ${{ steps.check-changes.outputs.changed }} |" >> $GITHUB_STEP_SUMMARY
        echo "| å¯¾è±¡ã‚¢ã‚¤ãƒ†ãƒ  | ${{ env.TARGET_ITEMS }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡ŒID | ${{ github.run_id }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ”§ ã‚¹ã‚¯ãƒªãƒ—ãƒˆæ§‹æˆ" >> $GITHUB_STEP_SUMMARY
        echo "| ã‚¹ã‚¯ãƒªãƒ—ãƒˆ | ç”¨é€” | çŠ¶æ…‹ |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| historical_price_tracker.py | å€‹åˆ¥ã‚¢ã‚¤ãƒ†ãƒ ä¾¡æ ¼å±¥æ­´ | âœ… å®Ÿè¡Œæ¸ˆã¿ |" >> $GITHUB_STEP_SUMMARY
        echo "| total_price_aggregator.py | ç·ä¾¡æ ¼é›†è¨ˆ | âœ… å®Ÿè¡Œæ¸ˆã¿ |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.check-changes.outputs.changed }}" == "true" ]; then
          echo "### âœ… æ›´æ–°çµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "- ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿æ›´æ–°: ${{ steps.check-changes.outputs.equipment_changed }}ãƒ•ã‚¡ã‚¤ãƒ«" >> $GITHUB_STEP_SUMMARY
          echo "- å±¥æ­´ãƒ‡ãƒ¼ã‚¿æ›´æ–°: ${{ steps.check-changes.outputs.history_changed }}ãƒ•ã‚¡ã‚¤ãƒ«" >> $GITHUB_STEP_SUMMARY
          echo "- ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ: å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "- ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥: å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ **ä¾¡æ ¼æ›´æ–°ã¨ãƒãƒ£ãƒ¼ãƒˆç”ŸæˆãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼**" >> $GITHUB_STEP_SUMMARY
        else
          echo "### â„¹ï¸ å®Ÿè¡Œçµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "- å¤‰æ›´ãªã—ï¼ˆä¾¡æ ¼ã«å¤‰å‹•ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "- ã‚·ã‚¹ãƒ†ãƒ ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«" >> $GITHUB_STEP_SUMMARY
        echo "- \`data/equipment_prices.json\`: æœ€æ–°ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿" >> $GITHUB_STEP_SUMMARY
        echo "- \`data/price_history/history_*.json\`: å€‹åˆ¥ã‚¢ã‚¤ãƒ†ãƒ å±¥æ­´" >> $GITHUB_STEP_SUMMARY
        echo "- \`data/price_history/total_price_*.json\`: ç·ä¾¡æ ¼å±¥æ­´" >> $GITHUB_STEP_SUMMARY
        echo "- \`data/price_history/*_*.json\`: å€‹åˆ¥ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿" >> $GITHUB_STEP_SUMMARY

    # ðŸš¨ ã‚¨ãƒ©ãƒ¼æ™‚ã®è¨ºæ–­æƒ…å ±
    - name: Collect diagnostic info on failure
      if: failure()
      run: |
        echo "ðŸš¨ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ è¨ºæ–­æƒ…å ±" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY  # â† ã“ã“ãŒå•é¡Œï¼
        echo "å®Ÿè¡Œæ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S JST')" >> $GITHUB_STEP_SUMMARY
        echo "Pythonç‰ˆæœ¬: $(python --version)" >> $GITHUB_STEP_SUMMARY
        echo "ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $(pwd)" >> $GITHUB_STEP_SUMMARY
        echo "åˆ©ç”¨å¯èƒ½ã‚¹ãƒšãƒ¼ã‚¹: $(df -h . | tail -1)" >> $GITHUB_STEP_SUMMARY
        
        if [ -d "data" ]; then
          echo "dataãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ :" >> $GITHUB_STEP_SUMMARY
          ls -la data/ >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -d "scripts" ]; then
          echo "scriptsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ :" >> $GITHUB_STEP_SUMMARY
          ls -la scripts/ >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY  # â† ã“ã“ã‚‚å•é¡Œï¼
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "â— **è§£æ±ºæ–¹æ³•**: ãƒ­ã‚°ã‚’ç¢ºèªã—ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ãé…ç½®ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
