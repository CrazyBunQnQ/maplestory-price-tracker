name: MapleStory Equipment Price Auto Update

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:
    inputs:
      target_items:
        description: 'Number of items to update (default: ALL)'
        default: 'ALL'
        type: string

permissions:
  contents: write
  actions: read

env:
  TZ: Asia/Tokyo

jobs:
  update-prices:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Setup Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Setup Chrome and ChromeDriver
      run: |
        sudo apt-get update
        sudo apt-get install -y wget gnupg
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
        echo "Using simplified ChromeDriver download approach"
        CHROMEDRIVER_VERSION="136.0.7103.92"
        
        CHROMEDRIVER_URL="https://storage.googleapis.com/chrome-for-testing-public/$CHROMEDRIVER_VERSION/linux64/chromedriver-linux64.zip"
        echo "Downloading from: $CHROMEDRIVER_URL"
        
        wget -O /tmp/chromedriver.zip "$CHROMEDRIVER_URL" || {
          echo "Download failed, trying alternative version"
          CHROMEDRIVER_VERSION="135.0.7103.92"
          CHROMEDRIVER_URL="https://storage.googleapis.com/chrome-for-testing-public/$CHROMEDRIVER_VERSION/linux64/chromedriver-linux64.zip"
          wget -O /tmp/chromedriver.zip "$CHROMEDRIVER_URL"
        }
        
        sudo unzip /tmp/chromedriver.zip -d /tmp/
        sudo mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver
        
        echo "Installation completed:"
        google-chrome --version
        chromedriver --version
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Set environment variables
      run: |
        TARGET_ITEMS="${{ github.event.inputs.target_items }}"
        if [ -z "$TARGET_ITEMS" ] || [ "$TARGET_ITEMS" = "null" ]; then
          TARGET_ITEMS="ALL"
        fi
        echo "TARGET_ITEMS=$TARGET_ITEMS" >> $GITHUB_ENV
        echo "PYTHONPATH=${{ github.workspace }}" >> $GITHUB_ENV
        echo "Setting TARGET_ITEMS to: $TARGET_ITEMS"
    
    - name: Update equipment prices
      run: |
        echo "ðŸ Starting MapleStory Equipment Price Auto Update at $(date '+%Y-%m-%d %H:%M:%S JST')"
        echo "Target items: $TARGET_ITEMS"
        echo "Working directory: $(pwd)"
        echo "Python version: $(python --version)"
        
        if [ -f "data/equipment_prices.json" ]; then
          ITEMS_BEFORE=$(python -c "import json; print(len(json.load(open('data/equipment_prices.json'))))" 2>/dev/null || echo "0")
          echo "Items in data before update: $ITEMS_BEFORE"
        else
          echo "Warning: data/equipment_prices.json not found"
        fi
        
        echo "ðŸ”„ Running update_prices.py..."
        python scripts/update_prices.py || {
          echo "âŒ update_prices.py failed with exit code $?"
          exit 1
        }
        
        if [ -f "data/equipment_prices.json" ]; then
          ITEMS_AFTER=$(python -c "import json; print(len(json.load(open('data/equipment_prices.json'))))" 2>/dev/null || echo "0")
          echo "Items in data after update: $ITEMS_AFTER"
        fi
        
        echo "âœ… MapleStory Equipment Price Auto Update completed at $(date '+%Y-%m-%d %H:%M:%S JST')"
    
    - name: Update individual item price history
      run: |
        echo "ðŸ”„ Starting individual item price history update at $(date '+%Y-%m-%d %H:%M:%S JST')"
        python scripts/historical_price_tracker.py
        echo "âœ… Individual item price history update completed at $(date '+%Y-%m-%d %H:%M:%S JST')"
    
    - name: Aggregate total price data
      run: |
        echo "ðŸ“Š Starting total price aggregation at $(date '+%Y-%m-%d %H:%M:%S JST')"
        python scripts/total_price_aggregator.py
        echo "âœ… Total price aggregation completed at $(date '+%Y-%m-%d %H:%M:%S JST')"
    
    - name: Export individual item chart data
      run: |
        echo "ðŸ“ˆ Exporting individual item chart data for web display"
        python -c "
        import sys
        sys.path.append('scripts')
        from historical_price_tracker import HistoricalPriceTracker
        import json
        import os
        
        try:
            tracker = HistoricalPriceTracker()
            
            if not os.path.exists('data/equipment_prices.json'):
                print('equipment_prices.json not found, skipping chart export')
                sys.exit(0)
            
            with open('data/equipment_prices.json', 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            exported = 0
            total_items = len(data)
            
            print(f'Starting chart export for {total_items} items...')
            
            for i, item_id in enumerate(data.keys()):
                if i % 50 == 0:
                    print(f'Progress: {i}/{total_items} items processed')
                
                for interval in ['1hour', '12hour', '1day']:
                    try:
                        if tracker.export_chart_data_for_web(item_id, interval):
                            exported += 1
                    except Exception as e:
                        print(f'Error exporting chart for item {item_id} ({interval}): {e}')
                        continue
            
            print(f'âœ… Exported {exported} individual item chart data files')
            
        except Exception as e:
            print(f'âŒ Error in chart export: {e}')
            sys.exit(1)
        "
    
    - name: Verify total price chart data
      run: |
        echo "ðŸ“Š Verifying total price chart data files"
        
        for interval in 1hour 12hour 1day; do
          file="data/price_history/total_price_${interval}.json"
          if [ -f "$file" ]; then
            size=$(stat -c%s "$file")
            echo "âœ… ${file}: ${size} bytes"
            
            if python -c "import json; json.load(open('$file'))"; then
              echo "   JSON format: valid"
            else
              echo "   âŒ JSON format: invalid"
            fi
          else
            echo "âŒ ${file}: not found"
          fi
        done
    
    - name: Check for changes with detailed analysis
      id: check-changes
      run: |
        echo "ðŸ” Analyzing changes in detail..."
        
        EQUIPMENT_CHANGED=0
        if [ -f "data/equipment_prices.json" ]; then
          if git diff --quiet data/equipment_prices.json; then
            echo "equipment_prices.json: No changes"
          else
            EQUIPMENT_CHANGED=1
            echo "equipment_prices.json: Changes detected"
            UPDATED_ITEMS=$(git diff data/equipment_prices.json | grep -c '^[+-].*"item_price"' || echo "0")
            echo "Price updates detected: $UPDATED_ITEMS items"
            echo "updated_items=$UPDATED_ITEMS" >> $GITHUB_OUTPUT
          fi
        fi
        
        HISTORY_CHANGED=$(git status --porcelain data/price_history/ | wc -l)
        
        if [ -n "$(git status --porcelain data/)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "âœ… Data changes detected:"
          git status --short data/
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ No changes detected in data directory"
        fi
        
        echo "equipment_changed=${EQUIPMENT_CHANGED}" >> $GITHUB_OUTPUT
        echo "history_changed=${HISTORY_CHANGED}" >> $GITHUB_OUTPUT
    
    - name: Commit and push changes
      if: steps.check-changes.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        
        UPDATED_COUNT="${{ steps.check-changes.outputs.updated_items || '0' }}"
        INDIVIDUAL_CHARTS=$(find data/price_history -name "*_1hour.json" ! -name "total_price_*" 2>/dev/null | wc -l || echo "0")
        TOTAL_CHARTS=$(find data/price_history -name "total_price_*.json" 2>/dev/null | wc -l || echo "0")
        CURRENT_TIME=$(date '+%Y-%m-%d %H:%M:%S JST')
        
        if [ -f "data/equipment_prices.json" ]; then
          TOTAL_ITEMS=$(python -c "import json; print(len(json.load(open('data/equipment_prices.json'))))" 2>/dev/null || echo "0")
        else
          TOTAL_ITEMS="0"
        fi
        
        git add data/
        
        # è¤‡æ•°è¡Œã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é©åˆ‡ã«å‡¦ç†
        cat > /tmp/commit_message.txt << 'EOF'
Auto-update: Equipment prices & historical data

ðŸ“Š Update Summary:
- Update time: ${CURRENT_TIME}
- Total items: ${TOTAL_ITEMS}
- Updated items: ${UPDATED_COUNT}
- Individual charts: ${INDIVIDUAL_CHARTS}
- Total price charts: ${TOTAL_CHARTS}
- Target setting: ${TARGET_ITEMS}

ðŸ”§ Architecture:
- Individual item history: scripts/historical_price_tracker.py
- Total price aggregation: scripts/total_price_aggregator.py
- Automated by GitHub Actions
EOF
        
        # å¤‰æ•°ã‚’å±•é–‹ã—ã¦ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
        sed -i "s/\${CURRENT_TIME}/${CURRENT_TIME}/g" /tmp/commit_message.txt
        sed -i "s/\${TOTAL_ITEMS}/${TOTAL_ITEMS}/g" /tmp/commit_message.txt
        sed -i "s/\${UPDATED_COUNT}/${UPDATED_COUNT}/g" /tmp/commit_message.txt
        sed -i "s/\${INDIVIDUAL_CHARTS}/${INDIVIDUAL_CHARTS}/g" /tmp/commit_message.txt
        sed -i "s/\${TOTAL_CHARTS}/${TOTAL_CHARTS}/g" /tmp/commit_message.txt
        sed -i "s/\${TARGET_ITEMS}/${TARGET_ITEMS}/g" /tmp/commit_message.txt
        
        git commit -F /tmp/commit_message.txt
        git push origin ${{ github.ref_name }}
        
        echo "âœ… Successfully updated ${UPDATED_COUNT} items with ${INDIVIDUAL_CHARTS} individual charts and ${TOTAL_CHARTS} total price charts"
    
    - name: Generate detailed summary
      run: |
        echo "## ðŸ MapleStory Equipment Price Auto Update Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š åŸºæœ¬æƒ…å ±" >> $GITHUB_STEP_SUMMARY
        echo "| Item | Result |" >> $GITHUB_STEP_SUMMARY
        echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| å®Ÿè¡Œæ™‚åˆ» | $(date '+%Y-%m-%d %H:%M:%S JST') |" >> $GITHUB_STEP_SUMMARY
        echo "| ãƒ‡ãƒ¼ã‚¿å¤‰æ›´ | ${{ steps.check-changes.outputs.changed }} |" >> $GITHUB_STEP_SUMMARY
        echo "| å¯¾è±¡ã‚¢ã‚¤ãƒ†ãƒ  | ${TARGET_ITEMS} |" >> $GITHUB_STEP_SUMMARY
        echo "| ä¾¡æ ¼æ›´æ–°ä»¶æ•° | ${{ steps.check-changes.outputs.updated_items || '0' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡ŒID | ${{ github.run_id }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ”§ ã‚¹ã‚¯ãƒªãƒ—ãƒˆæ§‹æˆ" >> $GITHUB_STEP_SUMMARY
        echo "| ã‚¹ã‚¯ãƒªãƒ—ãƒˆ | ç”¨é€” | çŠ¶æ…‹ |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| update_prices.py | ãƒ¡ã‚¤ãƒ³ä¾¡æ ¼æ›´æ–° | âœ… å®Ÿè¡Œæ¸ˆã¿ |" >> $GITHUB_STEP_SUMMARY
        echo "| historical_price_tracker.py | å€‹åˆ¥ã‚¢ã‚¤ãƒ†ãƒ ä¾¡æ ¼å±¥æ­´ | âœ… å®Ÿè¡Œæ¸ˆã¿ |" >> $GITHUB_STEP_SUMMARY
        echo "| total_price_aggregator.py | ç·ä¾¡æ ¼é›†è¨ˆ | âœ… å®Ÿè¡Œæ¸ˆã¿ |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.check-changes.outputs.changed }}" == "true" ]; then
          UPDATED_COUNT="${{ steps.check-changes.outputs.updated_items || '0' }}"
          echo "### âœ… æ›´æ–°çµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "- **ä¾¡æ ¼æ›´æ–°**: ${UPDATED_COUNT}ä»¶ã®ã‚¢ã‚¤ãƒ†ãƒ " >> $GITHUB_STEP_SUMMARY
          echo "- **ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«**: ${{ steps.check-changes.outputs.equipment_changed }}ãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°" >> $GITHUB_STEP_SUMMARY
          echo "- **å±¥æ­´ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«**: ${{ steps.check-changes.outputs.history_changed }}ãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ**: å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "- **ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥**: å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${UPDATED_COUNT}" -gt "0" ]; then
            echo "ðŸŽ‰ **${UPDATED_COUNT}ä»¶ã®ã‚¢ã‚¤ãƒ†ãƒ ä¾¡æ ¼ãŒæ­£å¸¸ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸï¼**" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **ä¾¡æ ¼ã«å¤‰å‹•ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸãŒã€ã‚·ã‚¹ãƒ†ãƒ ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™**" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "### â„¹ï¸ å®Ÿè¡Œçµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "- å¤‰æ›´ãªã—ï¼ˆä¾¡æ ¼ã«å¤‰å‹•ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "- update_prices.py ã¯æ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          echo "- ã‚·ã‚¹ãƒ†ãƒ ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«" >> $GITHUB_STEP_SUMMARY
        echo "- \`data/equipment_prices.json\`: æœ€æ–°ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿" >> $GITHUB_STEP_SUMMARY
        echo "- \`data/price_history/history_*.json\`: å€‹åˆ¥ã‚¢ã‚¤ãƒ†ãƒ å±¥æ­´" >> $GITHUB_STEP_SUMMARY
        echo "- \`data/price_history/total_price_*.json\`: ç·ä¾¡æ ¼å±¥æ­´" >> $GITHUB_STEP_SUMMARY
        echo "- \`data/price_history/*_*.json\`: å€‹åˆ¥ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿" >> $GITHUB_STEP_SUMMARY

    - name: Collect diagnostic info on failure
      if: failure()
      run: |
        echo "ðŸš¨ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ è¨ºæ–­æƒ…å ±" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "å®Ÿè¡Œæ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S JST')" >> $GITHUB_STEP_SUMMARY
        echo "Pythonç‰ˆæœ¬: $(python --version)" >> $GITHUB_STEP_SUMMARY
        echo "å¯¾è±¡ã‚¢ã‚¤ãƒ†ãƒ : ${TARGET_ITEMS}" >> $GITHUB_STEP_SUMMARY
        echo "ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $(pwd)" >> $GITHUB_STEP_SUMMARY
        echo "åˆ©ç”¨å¯èƒ½ã‚¹ãƒšãƒ¼ã‚¹: $(df -h . | tail -1)" >> $GITHUB_STEP_SUMMARY
        
        if [ -d "data" ]; then
          echo "dataãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ :" >> $GITHUB_STEP_SUMMARY
          ls -la data/ >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -d "scripts" ]; then
          echo "scriptsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ :" >> $GITHUB_STEP_SUMMARY
          ls -la scripts/ >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "â— **è§£æ±ºæ–¹æ³•**: ãƒ­ã‚°ã‚’ç¢ºèªã—ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ãé…ç½®ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
