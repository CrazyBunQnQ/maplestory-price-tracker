- name: Setup Chrome and ChromeDriver (改善版)
  run: |
    sudo apt-get update
    sudo apt-get install -y wget gnupg
    
    # Google Chrome安定版をインストール
    wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
    sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
    sudo apt-get update
    sudo apt-get install -y google-chrome-stable
    
    # インストールされたChromeのバージョンを取得
    CHROME_VERSION=$(google-chrome --version | cut -d ' ' -f3 | cut -d '.' -f1-3)
    echo "Chrome version: $CHROME_VERSION"
    
    # 対応するChromeDriverをダウンロード（より柔軟なアプローチ）
    CHROMEDRIVER_VERSION=$(curl -s "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_$CHROME_VERSION" || echo "114.0.5735.90")
    echo "Using ChromeDriver version: $CHROMEDRIVER_VERSION"
    
    # ChromeDriverダウンロード（フォールバック付き）
    CHROMEDRIVER_URL="https://chromedriver.storage.googleapis.com/$CHROMEDRIVER_VERSION/chromedriver_linux64.zip"
    wget -O /tmp/chromedriver.zip "$CHROMEDRIVER_URL" || {
      echo "Primary download failed, trying alternative..."
      wget -O /tmp/chromedriver.zip "https://storage.googleapis.com/chrome-for-testing-public/114.0.5735.90/linux64/chromedriver-linux64.zip"
    }
    
    sudo unzip /tmp/chromedriver.zip -d /tmp/
    
    # ChromeDriverの場所を確認してコピー
    if [ -f "/tmp/chromedriver" ]; then
      sudo mv /tmp/chromedriver /usr/local/bin/
    elif [ -f "/tmp/chromedriver-linux64/chromedriver" ]; then
      sudo mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin/
    fi
    
    sudo chmod +x /usr/local/bin/chromedriver
    
    echo "Installation completed:"
    google-chrome --version
    chromedriver --version
